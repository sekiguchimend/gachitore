ページ1：実装仕様書（Flutter × Supabase × Rust BFF × Gemini）
1. 概要
目的

筋トレ/食事/体重/睡眠などを日々記録

記録から 状態（State） を生成し、Geminiの回答品質を最大化

AI回答は保存し、継続ほど精度が上がる（資産化）

設計原則（軽さ）

Flutter：入力/UI（AI/集計ロジックは持たない）

Supabase：データの正本（Auth + Postgres + Storage）

Rust BFF：状態要約・AI呼び出し・保存・ガード（速く薄く）

Gemini：state_json + intent + message を基に JSON出力で返す

2. リポジトリ構成（モノレポ推奨）
repo/
  apps/mobile_flutter/
  services/bff_rust/
  supabase/migrations/
  supabase/seed/
  docs/api.md
  docs/state_schema.md

3. Supabase（DB）仕様
3.1 テーブル（MVP必須）

Auth：Supabase Auth（auth.users）

user_profiles

user_id uuid pk references auth.users(id)

display_name text

sex text null

birth_year int null

height_cm int null

training_level text（beginner/intermediate/advanced）

goal text（hypertrophy/cut/health/strength）

environment jsonb（ジム/自宅、器具、ベンチ等）

constraints jsonb（手首/肩/腰など）

created_at, updated_at

body_metrics

id uuid pk

user_id uuid

date date

weight_kg numeric(5,2) null

bodyfat_pct numeric(5,2) null

sleep_hours numeric(4,2) null

steps int null

note text null

created_at

workouts / workout_exercises / workout_sets

workouts(id, user_id, date, start_time, end_time, perceived_fatigue(1-5), note, created_at)

exercises(id, name, primary_muscle, equipment, is_system, created_at)

workout_exercises(id, workout_id, exercise_id null, custom_exercise_name null, muscle_tag, note)

workout_sets(id, workout_exercise_id, set_index, weight_kg, reps, rpe, rest_sec, tempo, created_at)

meals / meal_items / nutrition_daily

meals(id, user_id, date, time, meal_type, note, photo_url, created_at)

meal_items(id, meal_id, name, quantity, unit, calories, protein_g, fat_g, carbs_g)

nutrition_daily(id, user_id, date, calories, protein_g, fat_g, carbs_g, updated_at)（集計キャッシュ）

ai_sessions / ai_messages / ai_recommendations

ai_sessions(id, user_id, created_at, intent, state_version, model, input_summary jsonb, safety_flags jsonb)

ai_messages(id, session_id, role, content, created_at)

ai_recommendations(id, session_id, kind, payload jsonb, created_at)

3.2 インデックス

body_metrics(user_id, date)

workouts(user_id, date)

meals(user_id, date)

nutrition_daily(user_id, date)

ai_sessions(user_id, created_at desc)

workout_sets(workout_exercise_id, set_index)

3.3 RLS方針（必須）

user_id を持つテーブル：auth.uid() = user_id

workout_sets は workout_exercises -> workouts -> user_id を辿る

方針A：JOIN RLS（正攻法）

方針B：セット系は SECURITY DEFINER RPC 経由で書き込み（BFFのみ）

軽さ・実装容易性優先なら方針B推奨。

4. Rust BFF（Axum）仕様
4.1 役割

Supabase JWT検証 → user_id確定

Supabase DB読み書き

State生成（直近14日/7日）

Gemini呼び出し（JSON出力強制）

危険助言ガード（簡易でも必須）

生成物の保存（ai_sessions/messages/recommendations）

4.2 推奨クレート

axum, tokio, tower-http

serde, serde_json

reqwest

jsonwebtoken（JWKS）

uuid, chrono

tracing, tracing-subscriber

（直DBなら sqlx）

4.3 APIエンドポイント（MVP）

POST /v1/log/workout：セッション＋種目＋セットまとめて保存

POST /v1/log/meal：食事＋品目保存（写真URL含む）

GET /v1/dashboard/today?date=YYYY-MM-DD：日次集計

POST /v1/ai/ask：state生成→Gemini→保存→返却

POST /v1/ai/plan/today：今日のメニュー生成→保存→返却

4.4 State生成（v1固定）

profile/environment/today/last_14d/nutrition_7d_avg を 短いJSONで生成

e1RM推定：Epley e1rm = weight * (1 + reps/30)（reps 1〜12）

4.5 Gemini出力形式（必ずJSON）

出力スキーマ例：

{
  "answer_text": "…",
  "recommendations": [
    {"kind":"workout","payload": { }},
    {"kind":"nutrition","payload": { }}
  ],
  "warnings": ["…"]
}

5. Flutter仕様（軽さ最優先）
5.1 パッケージ（例）

supabase_flutter

dio or http

freezed + json_serializable

riverpod（推奨） / bloc

go_router

hive or shared_preferences

5.2 画面（MVP）

Onboarding（目標/器具/制約）

Dashboard（日次）

Workout Log（セット入力、前回重量サジェスト）

Meal Log（写真→後で詳細）

AI Coach（質問→回答→カード表示、履歴）